"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DecodedMessage = exports.writeRawSignatureHeader = exports.readRawSignatureHeader = exports.FrequencyPeak = exports.SampleRate = exports.FrequencyBand = void 0;
const buffer_1 = require("buffer");
var crc32 = function (str) {
    var c;
    var crcTable = [];
    for (var n = 0; n < 256; n++) {
        c = n;
        for (var k = 0; k < 8; k++) {
            c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
        }
        crcTable[n] = c;
    }
    var crc = 0 ^ (-1);
    for (var i = 0; i < str.length; i++) {
        crc = (crc >>> 8) ^ crcTable[(crc ^ str[i]) & 0xFF];
    }
    return (crc ^ (-1)) >>> 0;
};
var FrequencyBand;
(function (FrequencyBand) {
    FrequencyBand[FrequencyBand["_0_250"] = -1] = "_0_250";
    FrequencyBand[FrequencyBand["_250_520"] = 0] = "_250_520";
    FrequencyBand[FrequencyBand["_520_1450"] = 1] = "_520_1450";
    FrequencyBand[FrequencyBand["_1450_3500"] = 2] = "_1450_3500";
    FrequencyBand[FrequencyBand["_3500_5500"] = 3] = "_3500_5500";
})(FrequencyBand = exports.FrequencyBand || (exports.FrequencyBand = {}));
;
var SampleRate;
(function (SampleRate) {
    SampleRate[SampleRate["_8000"] = 1] = "_8000";
    SampleRate[SampleRate["_11025"] = 2] = "_11025";
    SampleRate[SampleRate["_16000"] = 3] = "_16000";
    SampleRate[SampleRate["_32000"] = 4] = "_32000";
    SampleRate[SampleRate["_44100"] = 5] = "_44100";
    SampleRate[SampleRate["_48000"] = 6] = "_48000";
})(SampleRate = exports.SampleRate || (exports.SampleRate = {}));
;
const DATA_URI_PREFIX = 'data:audio/vnd.shazam.sig;base64,';
class FrequencyPeak {
    constructor(fftPassNumber, peakMagnitude, correctedPeakFrequencyBin, sampleRateHz) {
        this.fftPassNumber = fftPassNumber;
        this.peakMagnitude = peakMagnitude;
        this.correctedPeakFrequencyBin = correctedPeakFrequencyBin;
        this.sampleRateHz = sampleRateHz;
    }
    getFrequencyHz() {
        return this.correctedPeakFrequencyBin * (this.sampleRateHz / 2 / 1024 / 64);
    }
    getAmplitudePcm() {
        return Math.sqrt(Math.exp((this.peakMagnitude - 6144) / 1477.3) * (1 << 17) / 2) / 1024;
    }
    getSeconds() {
        return (this.fftPassNumber * 128) / this.sampleRateHz;
    }
}
exports.FrequencyPeak = FrequencyPeak;
const readUint32 = (data) => {
    return (data[0] >> 24 |
        data[1] >> 16 |
        data[2] >> 8 |
        data[3]);
};
const padTo32 = (data) => new Uint8Array([...data, ...Array(4 - data.length).fill(0)]);
const readInt32 = (data) => new Int32Array(data)[0];
const writeUint32 = (e) => [e & 0xff, (e >> 8) & 0xff, (e >> 16) & 0xff, (e >> 24) & 0xff];
const writeInt32 = (e) => {
    let q = new DataView(new ArrayBuffer(4), 0);
    q.setInt32(0, e, true);
    return new Uint8Array(q.buffer);
};
const writeInt16 = (e) => {
    let q = new DataView(new ArrayBuffer(2), 0);
    q.setInt16(0, e, true);
    return new Uint8Array(q.buffer);
};
function readRawSignatureHeader(read) {
    const _readUint32 = () => readUint32(read(4));
    const clear = (e) => Array(e).fill(0).map(readUint32);
    const magic1 = _readUint32(), crc32 = _readUint32(), sizeMinusHeader = _readUint32(), magic2 = _readUint32(), _a = clear(3), shiftedSampleRateId = _readUint32(), _b = clear(2), numberSamplesPlusDividedSampleRate = _readUint32(), fixedValue = _readUint32();
    return { magic1, crc32, sizeMinusHeader, magic2, shiftedSampleRateId, numberSamplesPlusDividedSampleRate, fixedValue };
}
exports.readRawSignatureHeader = readRawSignatureHeader;
function writeRawSignatureHeader(rsh) {
    let buffer = [];
    let _writeUint32 = (e) => buffer.push(...writeUint32(e));
    _writeUint32(rsh.magic1);
    _writeUint32(rsh.crc32);
    _writeUint32(rsh.sizeMinusHeader);
    _writeUint32(rsh.magic2);
    _writeUint32(0);
    _writeUint32(0);
    _writeUint32(0);
    _writeUint32(rsh.shiftedSampleRateId);
    _writeUint32(0);
    _writeUint32(0);
    _writeUint32(rsh.numberSamplesPlusDividedSampleRate);
    _writeUint32(rsh.fixedValue);
    return new Uint8Array(buffer);
}
exports.writeRawSignatureHeader = writeRawSignatureHeader;
class DecodedMessage {
    constructor() {
        this.sampleRateHz = 0;
        this.numberSamples = 0;
        this.frequencyBandToSoundPeaks = {};
    }
    static decodeFromBinary(bytes) {
        let self = new DecodedMessage();
        let ptr = 0;
        const read = (e) => e === undefined ? bytes.slice(ptr, ptr = bytes.length) : bytes.slice(ptr, ptr += e);
        const seek = (e) => ptr = e;
        seek(8);
        const checksummableData = read();
        seek(0);
        const header = readRawSignatureHeader(read);
        if (header.magic1 != 0xcafe2580) {
            console.log("ASSERT 3 FAIL");
        }
        // TODO: Other asserts
        self.sampleRateHz = parseInt(SampleRate[header.shiftedSampleRateId >> 27].substring(1));
        self.numberSamples = Math.round(header.numberSamplesPlusDividedSampleRate - self.sampleRateHz * 0.24);
        while (true) {
            const tlvHeader = read(8);
            if (tlvHeader.length === 0)
                break;
            let frequencyBandId = readInt32(tlvHeader.slice(0, 4)), frequencyPeaksSize = readInt32(tlvHeader.slice(4));
            let frequencyPeaksPadding = 4 + (-frequencyPeaksSize % 4);
            read(frequencyPeaksPadding);
            let frequencyBand = (frequencyBandId - 0x60030040);
            let fftPassNumber = 0;
            self.frequencyBandToSoundPeaks[FrequencyBand[frequencyBand]] = [];
            while (true) {
                let rawFftPass = read(1);
                if (rawFftPass.length === 0)
                    break;
                let fftPassOffset = rawFftPass[0];
                if (fftPassOffset === 0xff) {
                    fftPassNumber = readInt32(read(4));
                    continue;
                }
                else {
                    fftPassNumber += fftPassOffset;
                }
                let peakMagnitude = readInt32(padTo32(read(2)));
                let correctedPeakFrequencyBin = readInt32(padTo32(read(2)));
                self.frequencyBandToSoundPeaks[FrequencyBand[frequencyBand]].push(new FrequencyPeak(fftPassNumber, peakMagnitude, correctedPeakFrequencyBin, self.sampleRateHz));
            }
        }
        return self;
    }
    static decodeFromUri(uri) {
        if (!uri.startsWith(DATA_URI_PREFIX)) {
            throw new Error("assert 4");
        }
        return this.decodeFromBinary(buffer_1.Buffer.from(uri.replace(DATA_URI_PREFIX, ""), "base64"));
    }
    encodeToBinary() {
        let header = {
            magic1: 0xcafe2580,
            magic2: 0x94119c00,
            shiftedSampleRateId: SampleRate[`_${this.sampleRateHz}`] << 27,
            fixedValue: ((15 << 19) + 0x40000),
            numberSamplesPlusDividedSampleRate: Math.round(this.numberSamples + this.sampleRateHz * 0.24),
            crc32: -1,
            sizeMinusHeader: -1
        };
        let contentsBuf = [];
        for (let x of Object.entries(this.frequencyBandToSoundPeaks).map(a => [FrequencyBand[a[0]], a[1]]).sort((a, b) => (a[0] - b[0]))) {
            const frequencyBand = x[0], frequencyPeaks = x[1];
            let peaksBuffer = [];
            let fftPassNumber = 0;
            for (let frequencyPeak of frequencyPeaks) {
                if (frequencyPeak.fftPassNumber < fftPassNumber) {
                    throw new Error("Assert 5");
                }
                if ((frequencyPeak.fftPassNumber - fftPassNumber) >= 0xff) {
                    peaksBuffer.push(0xff);
                    peaksBuffer.push(...writeInt32(frequencyPeak.fftPassNumber));
                    fftPassNumber = frequencyPeak.fftPassNumber;
                }
                peaksBuffer.push(frequencyPeak.fftPassNumber - fftPassNumber);
                peaksBuffer.push(...writeInt16(frequencyPeak.peakMagnitude - 1));
                peaksBuffer.push(...writeInt16(frequencyPeak.correctedPeakFrequencyBin - 1));
                fftPassNumber = frequencyPeak.fftPassNumber;
            }
            contentsBuf.push(...writeInt32(0x60030040 + frequencyBand));
            contentsBuf.push(...writeInt32(peaksBuffer.length));
            contentsBuf = contentsBuf.concat(peaksBuffer);
            let paddingCount = 4 - (peaksBuffer.length % 4);
            if (paddingCount < 4)
                contentsBuf.push(...Array(paddingCount).fill(0));
        }
        header.sizeMinusHeader = contentsBuf.length + 8;
        let buf = [];
        buf.push(...writeRawSignatureHeader(header));
        buf.push(...writeInt32(0x40000000));
        buf.push(...writeInt32(contentsBuf.length + 8));
        buf = buf.concat(contentsBuf);
        header.crc32 = crc32(buf.slice(8));
        let newHeader = writeRawSignatureHeader(header);
        buf.splice(0, newHeader.length, ...newHeader);
        return buf;
    }
    encodeToUri() {
        const bin = this.encodeToBinary();
        return DATA_URI_PREFIX + buffer_1.Buffer.from(bin).toString('base64');
    }
}
exports.DecodedMessage = DecodedMessage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmF0dXJlLWZvcm1hdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zaWduYXR1cmUtZm9ybWF0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFnQztBQUVoQyxJQUFJLEtBQUssR0FBRyxVQUFTLEdBQWE7SUFDOUIsSUFBSSxDQUFDLENBQUM7SUFDTixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFDbEIsS0FBSSxJQUFJLENBQUMsR0FBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBQztRQUN2QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ04sS0FBSSxJQUFJLENBQUMsR0FBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBQztZQUNyQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0RDtRQUNELFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbkI7SUFFRCxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFHO1FBQ2xDLEdBQUcsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7S0FDdkQ7SUFFRCxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FB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